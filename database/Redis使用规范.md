# Redis使用规范

## 一、总则

（一）目标

​	规范应用系统对基础技术组件Redis的使用，提高应用系统的可用性和可维护性。

（二）适用范围

​	开发、架构、测试、运维人员在使用Redis进行设计、开发、测试、运维时，需要参照本规范执行。



## 二、使用场景

​	Redis数据结构使用场景较多（见表1），因为在容量、网络、效率、可靠性和功能等方面的问题，不建议在消息队列和栈的场景中使用Redis；建议主要在缓存和分布式会话场景中使用Redis，要求不打开持久化功能。对于其他使用场景或有特殊需求的需提交技术方案报批。

​	注：Redis在数据一致性上AP模型，数据是异步复制的方式，因故障进行主从切换时是不保证副本数据强一致的，业务逻辑需兼容此类情况，例如锁和计数器的使用。

<center>表一 Redis使用场景</center>



| 数据结构               | 场景及说明                                                   |
| ---------------------- | ------------------------------------------------------------ |
| 字符串<br />（string） | **缓存**：利用Redis高并发的特性，起到加速读写和降低后台压力的作用。<br />**分布式会话**：在分布式系统中，利用Redis集中管理会话。<br />**计数器**：使用incr命令对值做自增操作。<br />**限速器**：使用incr和expire命令实现限速。 |
| 哈希<br />（hash）     | **对象缓存**：包含较多属性信息对象的存缓存。                 |
| 列表<br />（list）     | **消息队列**：使用lpush和rpop或（rpush和lpop）命令实现消息队列。<br />**栈**：使用lpush和lpop或（rpush和rpop）命令实现栈。 |
| 集合<br />（set）      | **标签**：使用sadd命令为元素添加标签，sinter命令获取元素的共同标签。<br />**抽奖**：使用srandmember命令随机弹出指定个数的元素。 |
| 有序集合<br />（zset） | **排行榜**：使用zadd命令初始化元素个数，zincrby命令新增计数，zrevrange命令获取计数排名前几的元素，zrange命令获取计数排名后及的元素。<br />**延迟消息队列**：使用zrangebyscore命令查找小于或者等于当前时间的元素。 |



## 三、使用规范

明确Redis的使用规范，不能满足以下规范的需提交技术方案报批。

（一）基本规范

> 1. 高频热点数据（QPS超过1000）可使用Redis做缓存，对于低频冷数据不应采用Redis做缓存。
>
> 2. 跨系统的数据共享应通过服务化的方式实现，不应采用访问同一redis实例数据的方式进行共享。
> 3. 需使用带有连接池的开发框架，可有效控制连接，同时提高效率。
> 4. 应降低技术组件与业务的耦合度，Redis作为缓存使用时，去掉Redis后业务逻辑不应发生改变。
> 5. 缓存数据要有效管理，可根据缓存数据的业务特性，选好缓存数据的清理策略，或设置好过期时间。
> 6. 对于有安全要求的访问，需设置合理的密码，如果有必要可以使用SSL加密访问。



（二）设计规范

>1. key的设计规范
>
>   key必须有良好的可读性和可管理性，在保证语义的前提下，应控制key的长度，对于缓存使用应设置key的超时时间。
>
>   key命名应采用小写字母和数字的组合，不应该包含特殊的字符，命名规则为“系统英文缩写:模块:业务含义”（采用英文":"分隔）。
>
>2. value的设计规范
>
>   string类型控制在10kb以内，hash、list、set、zset元素个数不得超过5000



（三）部署规范

​	Redis部署一般分为单机、主从、哨兵和集群模式，一般采用哨兵和集群模式。

 1. 哨兵模式：

    哨兵模型为Redis高可用的解决方案。对于一、二类系统应采用该方案，对于不同系统应单独搭建该模式的实例，并根据业务量和响应时间要求，选择相应的服务器资源。对于业务连续性有要求的系统，搭建灾备环境。

 2. 集群模式

    集群模式为Redis分布式的解决方案。为了减少Redis实例，提升资源利用率，降低管理复杂度，可按业务主体统一搭建公共Redis集群，对于三、四类系统采用该方案。新增接入集群时需确认Redis公共集群资源的可用情况。



（四）运维规范

1. 禁止生产使用keys、flushall、flushdb等命令。
2. 禁止生产环境进行不设置范围的批量操作。
3. 监控除了CPU、内存、QPS网络等基础指标监控，应对key信息（总数/过期数/淘汰数）、key命中信息（命中数、key未命中数、命中率）、数据文件、日志文件等进行监控。
4. 对于热点key（QPS>=3000）提供查询功能。

​	